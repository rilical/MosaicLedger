(()=>{"use strict";const t=t=>document.getElementById(t),e=t("c"),n=e?e.getContext("2d",{alpha:0}):null,i=t("overlay"),o=t("title"),r=t("msg"),a=t("start"),l=t("score"),c=t("best"),s=t("sessions"),d=t("time"),f=t("mute"),u=t("crash"),w=t("crashMsg"),h=t("reload");if(!e||!n)return w&&(w.textContent="Canvas 2D context not available."),u&&u.classList.remove("hidden"),void(h&&h.addEventListener("click",()=>window.location.reload()));const m="mosaicledger.game15k.",g=254,y=255,p=["#22c55e","#38bdf8","#fb7185","#f59e0b","#a78bfa","#2dd4bf","#f472b6","#e2e8f0"],x=(t,e,n)=>t<e?e:t>n?n:t,S=(t,e)=>{try{const n=window.localStorage.getItem(m+t),i=null==n?NaN:Number(n);return Number.isFinite(i)?i:e}catch{return e}},b=(t,e)=>{try{window.localStorage.setItem(m+t,String(e))}catch{}},v=(t,e)=>{try{window.localStorage.setItem(m+t,e?"1":"0")}catch{}};let C=S("best",0),k=S("sessions",0),A=(()=>{try{const t=window.localStorage.getItem(m+"mute");return"1"===t?1:0}catch{return 0}})();function M(){f.textContent=A?"Unmute":"Mute"}c.textContent=String(C),s.textContent=String(k),M();let R=439041101;const L=()=>{R|=0,R=R+1831565813|0;let t=Math.imul(R^R>>>15,1|R);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296},T=t=>L()*t|0;let E=null;const I=(t,e,n)=>{if(!A)try{const i=window.AudioContext||window.webkitAudioContext;if(!i)return;E||(E=new i),"suspended"===E.state&&E.resume();const o=E.currentTime,r=E.createOscillator(),a=E.createGain();r.type="sine",r.frequency.setValueAtTime(t,o),a.gain.setValueAtTime(1e-4,o),a.gain.exponentialRampToValueAtTime(n,o+.01),a.gain.exponentialRampToValueAtTime(1e-4,o+e),r.connect(a),a.connect(E.destination),r.start(o),r.stop(o+e+.02)}catch{}},D=10,F=14;let W=new Uint8Array(140),G=0,N=0,H=0,P=0,U=0,V=0,q=0,B=0,O=0,$=10;function z(){W.fill(g),U=0,q=0,R=439041101,V=L()<.18?y:T(p.length),l.textContent="0",d.textContent="60"}function X(){const i=Math.max(1,Math.min(2,window.devicePixelRatio||1));e.width=Math.floor(window.innerWidth*i),e.height=Math.floor(window.innerHeight*i),e.style.width=window.innerWidth+"px",e.style.height=window.innerHeight+"px",n.setTransform(i,0,0,i,0,0),function(){const e=t("hud").getBoundingClientRect().height+14,n=window.innerWidth,i=n-28,o=window.innerHeight-e-14;$=Math.max(12,Math.floor(Math.min(i/D,o/F))),B=Math.floor((n-$*D)/2),O=Math.floor(e+(o-$*F)/2)}()}function Y(t,e,i,o){n.fillStyle="rgba(2,6,23,0.9)",n.fillRect(t,e,i,o),n.strokeStyle="rgba(255,255,255,0.14)",n.lineWidth=1;for(let r=-o;r<i;r+=7)n.beginPath(),n.moveTo(t+r,e),n.lineTo(t+r+o,e+o),n.stroke()}function j(t,e,i,o,r){n.fillStyle=r,n.fillRect(t,e,i,o),n.fillStyle="rgba(255,255,255,0.18)",n.fillRect(t+1,e+1,i-2,3)}function J(){const t=window.innerWidth,e=window.innerHeight,i=n.createLinearGradient(0,0,0,e);i.addColorStop(0,"#070c1b"),i.addColorStop(1,"#050913"),n.fillStyle=i,n.fillRect(0,0,t,e);const o=n.createRadialGradient(t/2,O+$*F/2,40,t/2,O+$*F/2,$*F);o.addColorStop(0,"rgba(56,189,248,0.13)"),o.addColorStop(1,"rgba(0,0,0,0)"),n.fillStyle=o,n.fillRect(0,0,t,e),n.fillStyle="rgba(255,255,255,0.06)",n.fillRect(B-10,O-10,$*D+20,$*F+20);for(let t=0;t<F;t++)for(let e=0;e<D;e++){const i=t*D+e,o=B+e*$,r=O+t*$;n.fillStyle="rgba(255,255,255,0.05)",n.fillRect(o,r,$-1,$-1);const a=W[i];a!==g&&(a===y?Y(o+2,r+2,$-4,$-4):j(o+2,r+2,$-4,$-4,p[a]||"#94a3b8"))}const r=q%D,a=q/D|0;n.strokeStyle="rgba(255,255,255,0.75)",n.lineWidth=2,n.strokeRect(B+r*$+1,O+a*$+1,$-3,$-3);const l=B+$*D-62,c=O+$*F+16;n.fillStyle="rgba(0,0,0,0.35)",n.fillRect(l,c,52,52),V===y?Y(l+8,c+8,36,36):j(l+8,c+8,36,36,p[V]||"#94a3b8"),n.fillStyle="rgba(255,255,255,0.72)",n.font="12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",n.fillText("Next",l+8,c-6)}function K(t){if(!G)return;const e=W[t]===g?t:function(t){for(let e=0;e<W.length;e++){const n=(t+e)%W.length;if(W[n]===g)return n}return-1}(t+1);if(e<0)return Z("Grid full.");W[e]=V,q=e;let n=0;if(V===y)n=-3,I(140,.09,.06);else{n=1;const t=V,i=e%D,o=e/D|0;i>0&&W[e-1]===t&&(n+=2),i<9&&W[e+1]===t&&(n+=2),o>0&&W[e-D]===t&&(n+=2),o<13&&W[e+D]===t&&(n+=2),I(640+28*t,.05,.05)}U=Math.max(0,U+n),l.textContent=String(U),V=L()<.18?y:T(p.length)}function Q(t){var e;if(G&&!N)try{!function(t){const e=x(1-(t-P)/6e4,0,1),n=Math.ceil(60*e);if(d.textContent=String(n),e<=0)return Z("Time.");J(),H=requestAnimationFrame(Q)}(t)}catch(t){e=t,N=1,G=0,cancelAnimationFrame(H),w.textContent=String(e&&e.stack?e.stack:e),u.classList.remove("hidden")}}function Z(t){G=0,cancelAnimationFrame(H),U>C&&(C=U,b("best",C),c.textContent=String(C)),o.textContent="Game Over",r.textContent=`Score: ${U}. ${t||""} Tap Start to play again.`,a.textContent="Play again",i.classList.remove("hidden")}e.addEventListener("pointerdown",t=>{if(!G)return;try{e.setPointerCapture(t.pointerId)}catch{}const n=function(t,e){const n=Math.floor((t-B)/$),i=Math.floor((e-O)/$);return n<0||n>=D||i<0||i>=F?-1:i*D+n}(t.clientX,t.clientY);n>=0&&K(n),t.preventDefault()},{passive:0}),window.addEventListener("keydown",t=>{if("m"===t.key||"M"===t.key)return A=!A,v("mute",A),void M();if(!G)return;const e=q%D,n=q/D|0;let i=e,o=n;if("ArrowLeft"===t.key)i=e-1;else if("ArrowRight"===t.key)i=e+1;else if("ArrowUp"===t.key)o=n-1;else{if("ArrowDown"!==t.key)return"Enter"===t.key||" "===t.key?(K(q),void t.preventDefault()):void 0;o=n+1}q=x(o,0,13)*D+x(i,0,9),I(440,.02,.02),t.preventDefault()},{passive:0}),f.addEventListener("click",t=>{A=!A,v("mute",A),M(),I(520,.02,.02),t.preventDefault()}),a.addEventListener("click",()=>function(){if(!N){k+=1,b("sessions",k),s.textContent=String(k);try{const t=window.AudioContext||window.webkitAudioContext;t&&!E&&(E=new t),E&&"suspended"===E.state&&E.resume()}catch{}i.classList.add("hidden"),G=1,P=performance.now(),z(),X(),I(880,.05,.05),cancelAnimationFrame(H),H=requestAnimationFrame(Q)}}()),h.addEventListener("click",()=>window.location.reload()),window.addEventListener("resize",()=>{G&&X()},{passive:1}),z(),X(),J()})();
