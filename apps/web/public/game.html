<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Minesweeper (180s)</title>
    <style>
      :root {
        --bg0: #0b1220;
        --bg1: #050712;
        --card: rgba(255, 255, 255, 0.06);
        --t: #eef2ff;
        --mut: rgba(238, 242, 255, 0.7);
        --b: rgba(255, 255, 255, 0.12);
        --good: #22c55e;
        --warn: #f97316;
        --bad: #f43f5e;
        --accent: #38bdf8;
        --cell: #0f1a30;
        --cell2: #0b1528;
        --rev: #0a1020;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font:
          14px/1.4 ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial;
        color: var(--t);
        background: radial-gradient(
          1200px 700px at 20% 0%,
          #182a55 0%,
          var(--bg0) 42%,
          var(--bg1) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        box-sizing: border-box;
        overflow-x: hidden;
        min-height: 100%;
      }
      .app {
        width: 100%;
        max-width: min(520px, 100vw);
        display: grid;
        gap: 14px;
        box-sizing: border-box;
      }
      .top {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        justify-content: space-between;
      }
      h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
      }
      .meta {
        color: var(--mut);
        font-size: 12px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--b);
        border-radius: 14px;
        padding: 12px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
      }
      .pill {
        border: 1px solid var(--b);
        border-radius: 999px;
        padding: 6px 10px;
        background: rgba(0, 0, 0, 0.22);
        font-size: 12px;
      }
      .pill b {
        font-weight: 700;
      }
      .btns {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      button {
        appearance: none;
        border: 1px solid var(--b);
        background: rgba(0, 0, 0, 0.24);
        color: var(--t);
        border-radius: 12px;
        padding: 8px 10px;
        font-weight: 650;
      }
      button:active {
        transform: translateY(1px);
      }
      .primary {
        border-color: rgba(56, 189, 248, 0.45);
        background: rgba(56, 189, 248, 0.14);
      }
      .on {
        border-color: rgba(249, 115, 22, 0.55);
        background: rgba(249, 115, 22, 0.18);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(10, minmax(0, 1fr));
        gap: 6px;
        user-select: none;
        touch-action: manipulation;
        width: 100%;
        max-width: 100%;
      }
      .c {
        position: relative;
        width: 100%;
        aspect-ratio: 1/1;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: linear-gradient(180deg, var(--cell), var(--cell2));
        color: var(--t);
        font-weight: 800;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .c.rev {
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.25));
        border-color: rgba(255, 255, 255, 0.1);
      }
      .c.rev.mine {
        background: linear-gradient(180deg, rgba(244, 63, 94, 0.25), rgba(0, 0, 0, 0.25));
        border-color: rgba(244, 63, 94, 0.4);
      }
      .c.flag {
        outline: 2px solid rgba(234, 179, 8, 0.45);
      }
      .c.boom {
        background: linear-gradient(180deg, rgba(244, 63, 94, 0.38), rgba(0, 0, 0, 0.25));
        border-color: rgba(244, 63, 94, 0.55);
      }
      .scotty {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        aspect-ratio: 1;
        transform: translateY(-20px);
        border-radius: 10px;
        pointer-events: none;
        background-color: transparent;
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
      }
      .scotty-nervous { background-image: url(/scotty-tl.png); }
      .scotty-shocked { background-image: url(/scotty-tr.png); }
      .scotty-win {
        background-image: url(/scotty-bl.png);
        clip-path: inset(0 10px 5px 0);
        transform: translateY(-10px);
      }
      .scotty-bomb { background-image: url(/scotty-br.png); }
      @keyframes scotty-fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes scotty-fade-out {
        from { opacity: 1; }
        to { opacity: 0; }
      }
      @keyframes pulse-opacity {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }
      .scotty {
        opacity: 0;
        animation: scotty-fade-in 0.3s ease-out forwards;
      }
      .scotty.scotty-out {
        animation: scotty-fade-out 0.25s ease-out forwards;
      }
      .scotty.scotty-bomb {
        animation: scotty-fade-in 0.3s ease-out forwards, pulse-opacity 1.5s ease-in-out 0.3s infinite;
      }
      .grid-wrap {
        position: relative;
      }
      .center-scotty {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, calc(-50% - 25px)) scale(0.75);
        width: 88px;
        aspect-ratio: 1;
        pointer-events: none;
        background-color: transparent;
        background-image: url(/scotty-bl.png);
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
        clip-path: inset(0 10px 5px 0);
        opacity: 0;
      }
      .center-scotty.scotty-fade-in {
        animation: scotty-fade-in 0.3s ease-out forwards, pulse-opacity 1.5s ease-in-out 0.3s infinite;
      }
      .center-scotty.scotty-out {
        animation: scotty-fade-out 0.25s ease-out forwards;
      }
      .c:focus {
        outline: 2px solid rgba(56, 189, 248, 0.55);
        outline-offset: 1px;
      }
      .hint {
        color: var(--mut);
        font-size: 12px;
      }
      a {
        color: var(--accent);
      }
      #status.status-pulse {
        animation: pulse-opacity 1.5s ease-in-out infinite;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="top">
        <div>
          <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
            <h1>Minesweeper (180s)</h1>
            <a
              class="pill"
              href="/app/evidence"
              style="text-decoration: none; color: inherit; display: inline-flex"
              >Back</a
            >
          </div>
          <div class="meta">10x10 · 15 mines · first click safe</div>
        </div>
        <a
          class="pill primary"
          id="dashboardBtn"
          href="/app"
          style="text-decoration: none; color: inherit; display: inline-flex"
          >Dashboard</a
        >
        <div class="pill" id="status" style="display: none">READY</div>
      </div>

      <div class="card">
        <div class="row">
          <div class="pill">Time: <b id="time">180</b>s</div>
          <div class="pill">Mines: <b id="mines">15</b></div>
          <div class="pill">Safe left: <b id="left">85</b></div>
          <div class="btns">
            <button id="flag" class="primary" type="button">Flag: OFF</button>
            <button id="restart" type="button">Restart</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="grid-wrap">
          <div class="grid" id="grid" aria-label="Minesweeper board"></div>
          <div class="center-scotty" id="centerScotty" aria-hidden="true"></div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        var N = 10,
          M = 15,
          L = 180,
          grid = document.getElementById('grid');
        var elT = document.getElementById('time'),
          elM = document.getElementById('mines'),
          elL = document.getElementById('left');
        var elD = document.getElementById('dashboardBtn'),
          elS = document.getElementById('status'),
          centerScottyEl = document.getElementById('centerScotty'),
          btnF = document.getElementById('flag'),
          btnR = document.getElementById('restart');
        var flagMode = 0,
          started = 0,
          over = 0,
          timer = 0,
          remain = L,
          seed = location.search.match(/(?:\\?|&)seed=([^&]+)/);
        var audioCtx = null,
          bgMusicStarted = false;
        function getCtx() {
          if (!audioCtx) {
            try {
              audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {}
          }
          return audioCtx;
        }
        function scheduleBgLoop(ctx, t) {
          var BPM = 72,
            beat = 60 / BPM,
            len = 12 * beat,
            n = [
              [329.63, 0, 1],
              [329.63, 1, 1],
              [392, 2, 2],
              [261.63, 4, 1],
              [246.94, 5, 1],
              [220, 6, 2],
              [196, 8, 1],
              [220, 9, 1],
              [246.94, 10, 1],
              [261.63, 11, 1]
            ],
            i, st, d, o, g;
          for (i = 0; i < n.length; i++) {
            st = t + n[i][1] * beat;
            d = n[i][2] * beat;
            o = ctx.createOscillator();
            g = ctx.createGain();
            o.type = 'triangle';
            o.frequency.setValueAtTime(n[i][0], st);
            g.gain.setValueAtTime(0, st);
            g.gain.linearRampToValueAtTime(0.18, st + 0.06);
            g.gain.linearRampToValueAtTime(0.11, st + d - 0.08);
            g.gain.linearRampToValueAtTime(0.001, st + d);
            o.connect(g);
            g.connect(ctx.destination);
            o.start(st);
            o.stop(st + d);
          }
          setTimeout(function () {
            scheduleBgLoop(ctx, t + len);
          }, (len - 0.2) * 1000);
        }
        function startBgMusic() {
          if (bgMusicStarted) return;
          bgMusicStarted = true;
          var ctx = getCtx();
          if (!ctx) return;
          try {
            if (ctx.state === 'suspended') ctx.resume();
            scheduleBgLoop(ctx, ctx.currentTime);
          } catch (e) {}
        }
        function playExplosion() {
          var ctx = getCtx();
          if (!ctx) return;
          try {
            if (ctx.state === 'suspended') ctx.resume();
            var t = ctx.currentTime;
            var buf = ctx.createBuffer(1, ctx.sampleRate * 0.15, ctx.sampleRate);
            var d = buf.getChannelData(0);
            for (var i = 0; i < d.length; i++)
              d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / d.length, 2);
            var src = ctx.createBufferSource();
            src.buffer = buf;
            var g = ctx.createGain();
            g.gain.setValueAtTime(0.4, t);
            g.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
            src.connect(g);
            g.connect(ctx.destination);
            src.start(t);
            var osc = ctx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(80, t);
            osc.frequency.exponentialRampToValueAtTime(20, t + 0.1);
            var g2 = ctx.createGain();
            g2.gain.setValueAtTime(0.25, t);
            g2.gain.exponentialRampToValueAtTime(0.01, t + 0.12);
            osc.connect(g2);
            g2.connect(ctx.destination);
            osc.start(t);
            osc.stop(t + 0.12);
          } catch (e) {}
        }
        function playVictory() {
          var ctx = getCtx();
          if (!ctx) return;
          try {
            if (ctx.state === 'suspended') ctx.resume();
            var t = ctx.currentTime;
            var freqs = [523.25, 659.25, 783.99, 1046.5];
            for (var i = 0; i < freqs.length; i++) {
              (function (f, i) {
                var osc = ctx.createOscillator();
                osc.type = 'square';
                osc.frequency.setValueAtTime(f, t);
                var g = ctx.createGain();
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(0.12, t + 0.03);
                g.gain.exponentialRampToValueAtTime(0.01, t + 0.25);
                osc.connect(g);
                g.connect(ctx.destination);
                osc.start(t + i * 0.12);
                osc.stop(t + i * 0.12 + 0.25);
              })(freqs[i], i);
            }
          } catch (e) {}
        }
        function h(s) {
          for (var i = 0, x = 2166136261 >>> 0; i < s.length; i++) {
            x ^= s.charCodeAt(i);
            x = Math.imul(x, 16777619);
          }
          return x >>> 0;
        }
        var rng = (function (a) {
          return function () {
            a |= 0;
            a = (a + 0x6d2b79f5) | 0;
            var t = Math.imul(a ^ (a >>> 15), 1 | a);
            t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
          };
        })(h(decodeURIComponent(seed ? seed[1] : '0')));
        function idx(r, c) {
          return r * N + c;
        }
        function inb(r, c) {
          return r >= 0 && c >= 0 && r < N && c < N;
        }
        function neigh(i) {
          var r = (i / N) | 0,
            c = i % N,
            a = [];
          for (var dr = -1; dr <= 1; dr++)
            for (var dc = -1; dc <= 1; dc++) {
              if (!dr && !dc) continue;
              var rr = r + dr,
                cc = c + dc;
              if (inb(rr, cc)) a.push(idx(rr, cc));
            }
          return a;
        }
        function setStatus(t, tone) {
          elS.textContent = t;
          elD.style.display = 'none';
          elS.style.display = 'inline-flex';
          if (t === 'READY') elS.classList.add('status-pulse');
          else elS.classList.remove('status-pulse');
        }
        function mk() {
          grid.innerHTML = '';
          lastScottyEl = null;
          over = 0;
          started = 0;
          remain = L;
          elT.textContent = remain;
          setStatus('READY');
          S = [];
          for (var i = 0; i < N * N; i++) S.push({ m: 0, r: 0, f: 0, a: 0, b: 0, el: null });
          for (var i = 0; i < N * N; i++) {
            var b = document.createElement('button');
            b.type = 'button';
            b.className = 'c';
            b.setAttribute('aria-label', 'cell');
            (function (ii, bb) {
              bb.oncontextmenu = function (e) {
                e.preventDefault();
                tog(ii);
                return false;
              };
              var lp = 0,
                tid = 0;
              bb.ontouchstart = function () {
                lp = 0;
                tid = setTimeout(function () {
                  lp = 1;
                  tog(ii);
                }, 380);
              };
              bb.ontouchend = function () {
                clearTimeout(tid);
                if (!lp) act(ii);
              };
              bb.onclick = function () {
                act(ii);
              };
            })(i, b);
            S[i].el = b;
            grid.appendChild(b);
          }
          elM.textContent = M;
          safeLeft = N * N - M;
          elL.textContent = safeLeft;
          if (centerScottyEl) {
            centerScottyEl.style.display = '';
            centerScottyEl.classList.remove('scotty-out', 'scotty-fade-in');
            void centerScottyEl.offsetHeight;
            centerScottyEl.classList.add('scotty-fade-in');
          }
        }
        function placeSafe(first) {
          var ban = {};
          ban[first] = 1;
          var ns = neigh(first);
          for (var i = 0; i < ns.length; i++) ban[ns[i]] = 1;
          var spots = [];
          for (var i = 0; i < N * N; i++) if (!ban[i]) spots.push(i);
          for (var k = spots.length - 1; k > 0; k--) {
            var j = (rng() * (k + 1)) | 0;
            var t = spots[k];
            spots[k] = spots[j];
            spots[j] = t;
          }
          for (var i = 0; i < M; i++) S[spots[i]].m = 1;
          for (var i = 0; i < N * N; i++) {
            if (S[i].m) continue;
            var n = neigh(i),
              c = 0;
            for (var j = 0; j < n.length; j++) if (S[n[j]].m) c++;
            S[i].a = c;
          }
        }
        function start() {
          if (started) return;
          started = 1;
          if (centerScottyEl) {
            centerScottyEl.classList.remove('scotty-fade-in');
            centerScottyEl.classList.add('scotty-out');
            centerScottyEl.addEventListener('animationend', function done() {
              centerScottyEl.removeEventListener('animationend', done);
              centerScottyEl.style.display = 'none';
              centerScottyEl.classList.remove('scotty-out');
            });
          }
          setStatus('RUNNING', 'rgba(56,189,248,.45)');
          timer = setInterval(function () {
            if (over) return;
            remain--;
            elT.textContent = remain;
            if (remain <= 0) {
              lose(-1);
            }
          }, 1000);
        }
        function tog(i) {
          if (over) return;
          var s = S[i];
          if (s.r) return;
          s.f = !s.f;
          s.el.classList.toggle('flag', s.f);
          s.el.textContent = s.f ? 'F' : '';
          var flags = 0;
          for (var k = 0; k < N * N; k++) if (S[k].f) flags++;
          elM.textContent = Math.max(0, M - flags);
        }
        function act(i) {
          if (over) return;
          if (!started) {
            placeSafe(i);
            start();
          }
          var s = S[i];
          if (flagMode) {
            tog(i);
            return;
          }
          if (s.f || s.r) return;
          if (s.m) {
            lose(i);
            return;
          }
          function doRevealAndScotty() {
            rev(i);
            var frame = s.a >= 3 ? 'shocked' : 'nervous';
            lastScottyEl = addScotty(s.el, frame);
            if (safeLeft <= 0) win();
          }
          if (lastScottyEl && lastScottyEl.parentNode) {
            var elToFade = lastScottyEl;
            lastScottyEl = null;
            elToFade.classList.add('scotty-out');
            elToFade.addEventListener('animationend', function done() {
              elToFade.removeEventListener('animationend', done);
              if (elToFade.parentNode) elToFade.parentNode.removeChild(elToFade);
              doRevealAndScotty();
            });
            return;
          }
          doRevealAndScotty();
        }
        function rev(i) {
          var q = [i];
          while (q.length) {
            var x = q.pop(),
              s = S[x];
            if (s.r) continue;
            if (s.f) {
              s.f = 0;
              s.el.classList.remove('flag');
              s.el.textContent = '';
              var flags = 0;
              for (var k = 0; k < N * N; k++) if (S[k].f) flags++;
              elM.textContent = Math.max(0, M - flags);
            }
            s.r = 1;
            safeLeft--;
            elL.textContent = safeLeft;
            s.el.classList.add('rev');
            if (s.a) {
              s.el.textContent = s.a;
              continue;
            }
            var n = neigh(x);
            for (var j = 0; j < n.length; j++) {
              var t = S[n[j]];
              if (!t.r && !t.m) q.push(n[j]);
            }
          }
        }
        function lose(hit) {
          over = 1;
          clearInterval(timer);
          playExplosion();
          setStatus(hit < 0 ? 'TIME OUT' : 'BOOM', 'rgba(244,63,94,.55)');
          for (var i = 0; i < N * N; i++) {
            var s = S[i];
            if (s.m) {
              s.el.textContent = '*';
              s.el.classList.add('rev', 'mine');
            }
          }
          if (hit >= 0) {
            if (lastScottyEl && lastScottyEl.parentNode) {
              lastScottyEl.parentNode.removeChild(lastScottyEl);
              lastScottyEl = null;
            }
            S[hit].el.classList.add('boom');
            addScotty(S[hit].el, 'bomb');
          }
        }
        function win() {
          over = 1;
          clearInterval(timer);
          playVictory();
          setStatus('CLEARED', 'rgba(34,197,94,.55)');
          if (lastScottyEl) lastScottyEl.className = 'scotty scotty-win';
        }
        btnF.onclick = function () {
          flagMode = !flagMode;
          btnF.textContent = 'Flag: ' + (flagMode ? 'ON' : 'OFF');
          btnF.classList.toggle('on', flagMode);
        };
        btnR.onclick = function () {
          clearInterval(timer);
          mk();
        };
        var S = [],
          safeLeft = 0,
          lastScottyEl = null;
        function addScotty(el, frame) {
          var d = document.createElement('div');
          d.className = 'scotty scotty-' + frame;
          el.appendChild(d);
          return d;
        }
        mk();
        document.addEventListener('click', function startOnClick() {
          document.removeEventListener('click', startOnClick);
          startBgMusic();
        }, { once: true });
      })();
    </script>
  </body>
</html>
